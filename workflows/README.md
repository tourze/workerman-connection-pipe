# Workerman 连接管道工作流程图

本目录包含各类协议组合的连接管道工作流程图及其详细说明。这些图表和文档旨在帮助开发者快速理解数据流转过程和内部实现机制。

## 可用工作流程图

1. [TCP 到 TCP 连接转发流程](./tcp_to_tcp_workflow.md)
   - **适用场景**：TCP 代理服务器、负载均衡、透明网关、反向代理
   - **核心特性**：完整的流量控制、双向连接状态监控、自动资源释放
   - **关键技术**：缓冲区管理、暂停/恢复数据接收

2. [TCP 到 UDP 连接转发流程](./tcp_to_udp_workflow.md)
   - **适用场景**：DNS 代理、TCP 客户端访问 UDP 服务、协议转换网关
   - **核心特性**：有状态到无状态的协议转换、目标地址动态设置
   - **关键技术**：连接状态维护、请求-响应映射

3. [UDP 到 TCP 连接转发流程](./udp_to_tcp_workflow.md)
   - **适用场景**：UDP 客户端访问 TCP 服务、游戏服务器、流媒体转发
   - **核心特性**：客户端识别与映射、会话维护、数据包聚合
   - **关键技术**：源地址跟踪、TCP 连接池管理

4. [UDP 到 UDP 连接转发流程](./udp_to_udp_workflow.md)
   - **适用场景**：UDP 中继、NAT 穿透、游戏加速器、P2P 通信中继
   - **核心特性**：高性能无状态转发、完全锥型 NAT 支持、超时清理
   - **关键技术**：地址映射表、并发控制、资源管理

## 架构组件

1. **管道类层次结构**
   - `AbstractConnectionPipe`：提供通用管道功能和接口实现
   - `TcpToTcpPipe`：TCP 到 TCP 数据转发实现
   - `TcpToUdpPipe`：TCP 到 UDP 数据转发实现
   - `UdpToTcpPipe`：UDP 到 TCP 数据转发实现
   - `UdpToUdpPipe`：UDP 到 UDP 数据转发实现

2. **辅助模块**
   - `PipeFactory`：管道工厂，简化管道创建过程
   - `Container`：依赖容器，管理日志和事件分发器
   - `NatManager`：地址映射管理，处理 NAT 穿透相关功能

3. **事件系统**
   - `DataForwardedEvent`：数据转发成功事件
   - `ForwardFailedEvent`：数据转发失败事件
   - 可通过事件监听器实现自定义监控和处理

## 实现原理

1. **连接抽象**
   - 基于 Workerman 的 `ConnectionInterface` 实现连接抽象
   - 通过 `TcpConnection` 和 `UdpConnection` 处理不同协议特性

2. **数据流向**
   - 源连接 → 管道对象 → 目标连接
   - 关键点在于 `forward()` 方法实现数据转发逻辑

3. **资源管理**
   - 自动连接生命周期管理
   - 通过 `pipe()` 和 `unpipe()` 控制管道状态
   - 合理使用 WeakMap 和引用计数避免资源泄漏

## 工作流程图格式说明

每个工作流程图使用 Mermaid 语法编写，主要包含以下部分：

1. **初始化流程**：建立连接，配置管道，设置回调函数
2. **数据转发流程**：数据从源到目标的传输路径和处理逻辑
3. **响应处理流程**：响应数据的接收和反向转发
4. **异常处理流程**：错误处理、重试机制和资源释放
5. **连接关闭流程**：连接终止时的清理操作和状态转换

每个流程图均包含详细注释，解释关键步骤和技术要点。
